<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repository Tag Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: visible;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            border-radius: 12px 12px 0 0;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .controls input[type="file"] {
            flex: 1;
            min-width: 200px;
            padding: 10px 15px;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            background: white;
        }

        .controls button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .controls button:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .refresh-btn {
            background: #28a745;
        }

        .refresh-btn:hover {
            background: #218838;
        }

        .bulk-tag-btn {
            background: #fd7e14;
        }

        .bulk-tag-btn:hover {
            background: #e8590c;
        }

        .sort-dropdown {
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
            cursor: pointer;
        }

        .sort-dropdown:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }

        .stats {
            padding: 20px 30px;
            background: #f8f9fa;
            display: flex;
            gap: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 5px;
        }

        .content {
            padding: 30px;
        }

        .repo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .repo-card {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s;
            background: white;
            position: relative;
            overflow: visible;
        }

        .repo-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }

        .repo-name {
            font-size: 1.25rem;
            font-weight: 600;
            color: #212529;
            margin-bottom: 10px;
            word-break: break-word;
        }

        .repo-projects {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .repo-project {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .project-label {
            font-weight: 600;
        }

        .tags-section {
            margin-top: 15px;
        }

        .tags-header {
            font-size: 0.9rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tag-count {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
        }

        .tags-list {
            display: flex;
            flex-wrap: wrap;
            position: relative;
            gap: 8px;
        }

        .tag {
            background: #e7f5ff;
            color: #1971c2;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-family: 'Courier New', monospace;
            border: 1px solid #a5d8ff;
            cursor: help;
            position: relative;
        }

        .tag:hover {
            background: #d0ebff;
            border-color: #74c0fc;
        }

        .tag-tooltip {
            visibility: hidden;
            background-color: #2c3e50;
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 9999;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 0.75rem;
            font-family: 'Courier New', monospace;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            pointer-events: none;
        }

        .tag-tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #2c3e50 transparent transparent transparent;
        }

        .tag:hover .tag-tooltip {
            visibility: visible;
            opacity: 1;
        }

        .commits-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #e9ecef;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 1000px;
            }
        }

        .commits-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .commits-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            margin-bottom: 5px;
        }

        .commits-controls {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
            min-width: 100%;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .commits-controls label {
            font-size: 0.75rem;
            color: #495057;
            font-weight: 600;
        }

        .commits-controls select {
            padding: 4px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.75rem;
            background: white;
            cursor: pointer;
            min-width: 80px;
        }

        .commits-controls input[type="text"] {
            padding: 4px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.75rem;
            width: 120px;
            background: white;
        }

        .commits-controls button {
            padding: 4px 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: background 0.2s;
        }

        .commits-controls button:hover {
            background: #5568d3;
        }

        .commits-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            background: #f8f9fa;
        }

        .commit-item {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            background: white;
            transition: background 0.2s;
        }

        .commit-item:last-child {
            border-bottom: none;
        }

        .commit-item:hover {
            background: #f8f9fa;
        }

        .commit-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            gap: 10px;
            margin-bottom: 6px;
        }

        .commit-hash {
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            color: #667eea;
            background: #e7f5ff;
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid #a5d8ff;
        }

        .commit-date {
            font-size: 0.75rem;
            color: #6c757d;
        }

        .commit-subject {
            font-size: 0.85rem;
            color: #2c3e50;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .commit-author {
            font-size: 0.75rem;
            color: #6c757d;
        }

        .commit-tags {
            margin-top: 6px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
            font-size: 0.75rem;
        }

        .commit-tag {
            background: #fff3cd;
            color: #856404;
            padding: 2px 8px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.7rem;
            border: 1px solid #ffc107;
            font-weight: 500;
        }

        .commit-body {
            margin-top: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-left: 3px solid #667eea;
            font-size: 0.75rem;
            color: #495057;
            white-space: pre-wrap;
            border-radius: 4px;
        }

        .commits-loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-size: 0.85rem;
        }

        .commits-error {
            background: #fff5f5;
            border: 1px solid #feb2b2;
            color: #c53030;
            padding: 12px;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .repo-card.clickable {
            cursor: pointer;
        }

        .repo-card.clickable:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #6c757d;
        }

        .error {
            background: #fff5f5;
            border: 2px solid #feb2b2;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .empty {
            text-align: center;
            padding: 60px;
            color: #6c757d;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .repo-grid {
                grid-template-columns: 1fr;
            }
            
            .stats {
                flex-direction: column;
                gap: 15px;
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-header h2 {
            color: #212529;
            font-size: 1.5rem;
        }

        .close-btn {
            font-size: 28px;
            font-weight: bold;
            color: #6c757d;
            cursor: pointer;
            border: none;
            background: none;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 28px;
            text-align: center;
        }

        .close-btn:hover {
            color: #212529;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.95rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .branch-check {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .branch-check h3 {
            font-size: 1rem;
            margin-bottom: 10px;
            color: #495057;
        }

        .branch-status {
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
        }

        .branch-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
        }

        .branch-item.has-branch {
            background: #d4edda;
        }

        .branch-item.no-branch {
            background: #f8d7da;
        }

        .branch-item.checking {
            background: #fff3cd;
        }

        .branch-icon {
            font-size: 1.2rem;
        }

        .branch-repo-name {
            flex: 1;
            font-weight: 500;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding-top: 15px;
            border-top: 2px solid #e9ecef;
        }

        .modal-footer button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
        }

        .btn-cancel:hover {
            background: #5a6268;
        }

        .btn-execute {
            background: #fd7e14;
            color: white;
        }

        .btn-execute:hover {
            background: #e8590c;
        }

        .btn-execute:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .progress-log {
            background: #212529;
            color: #00ff00;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .progress-log-line {
            margin-bottom: 5px;
        }

        .progress-log-line.success {
            color: #00ff00;
        }

        .progress-log-line.error {
            color: #ff4444;
        }

        .progress-log-line.info {
            color: #66b3ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì¶ Repository Tag Viewer</h1>
            <p>Visualize repositories and their Git tags</p>
        </div>

        <div class="controls">
            <button id="refreshBtn" class="refresh-btn">Refresh Tags</button>
            <button id="bulkTagBtn" class="bulk-tag-btn">Bulk Tag from Branch</button>
            <select id="sortOrder" class="sort-dropdown" title="Sort tags by">
                <option value="name-desc">Sort: Name (Z-A)</option>
                <option value="name-asc">Sort: Name (A-Z)</option>
                <option value="commit-desc">Sort: Commit (Recent First)</option>
                <option value="commit-asc">Sort: Commit (Oldest First)</option>
            </select>
            <input type="text" id="searchBox" class="search-box" placeholder="Search repositories or tags..." />
        </div>

        <div class="stats hidden" id="stats">
            <div class="stat">
                <div class="stat-value" id="repoCount">0</div>
                <div class="stat-label">Repositories</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="tagCount">0</div>
                <div class="stat-label">Total Tags</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="projectCount">0</div>
                <div class="stat-label">Projects</div>
            </div>
        </div>

        <div class="content">
            <div id="output">
                <div class="loading">
                    <h3>Loading...</h3>
                    <p>Fetching configuration and repository tags</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Tagging Modal -->
    <div id="bulkTagModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üè∑Ô∏è Bulk Tag from Branch</h2>
                <button class="close-btn" onclick="closeBulkTagModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="branchInput">Branch Name:</label>
                    <input type="text" id="branchInput" placeholder="e.g., dev, main, feature/xyz" />
                </div>
                <div class="form-group">
                    <label for="tagInput">Tag Name:</label>
                    <input type="text" id="tagInput" placeholder="e.g., v1.0.0, dev-release" />
                </div>
                <button onclick="checkBranches()" class="controls button">Check Branch Availability</button>
                
                <div id="branchCheckResults" class="branch-check" style="display: none;">
                    <h3>Branch Status:</h3>
                    <div id="branchStatus" class="branch-status"></div>
                </div>

                <div id="progressLog" class="progress-log" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeBulkTagModal()">Cancel</button>
                <button id="executeTagBtn" class="btn-execute" onclick="executeBulkTag()" disabled>Execute Tagging</button>
            </div>
        </div>
    </div>

    <script>
        let allRepos = [];
        let config = null;
        let currentSortOrder = 'name-desc';
        let branchCheckResults = {};

        document.getElementById('refreshBtn').addEventListener('click', loadAndRefresh);
        document.getElementById('bulkTagBtn').addEventListener('click', openBulkTagModal);
        document.getElementById('searchBox').addEventListener('input', filterRepos);
        document.getElementById('sortOrder').addEventListener('change', (e) => {
            currentSortOrder = e.target.value;
            filterRepos();
        });

        // Auto-load config on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadAndRefresh();
        });

        async function loadAndRefresh() {
            try {
                showLoading();
                
                // Fetch config from backend
                const configResponse = await fetch('/api/config');
                if (!configResponse.ok) {
                    throw new Error('Failed to load configuration from server');
                }
                
                config = await configResponse.json();
                
                if (!config.repositories || !Array.isArray(config.repositories)) {
                    throw new Error('Invalid configuration: repositories array not found');
                }

                await fetchAllTags();
                renderRepos(allRepos);
                updateStats();
            } catch (error) {
                showError('Error loading configuration: ' + error.message);
            }
        }

        async function fetchAllTags() {
            const promises = config.repositories.map(async (repo) => {
                const tags = await fetchRepoTags(repo);
                return {
                    ...repo,
                    tags: tags || []
                };
            });

            allRepos = await Promise.all(promises);
        }

        async function fetchRepoTags(repo) {
            try {
                const params = new URLSearchParams({
                    org: config.organization,
                    project: repo.project || repo.repo,
                    repo: repo.repo,
                    baseUrl: repo.baseUrl || config.baseUrl
                });
                
                const response = await fetch(`/api/tags?${params}`);
                
                if (!response.ok) {
                    console.warn(`Failed to fetch tags for ${repo.repo}: ${response.status}`);
                    return [];
                }
                
                const data = await response.json();
                return data.tags || [];
            } catch (error) {
                console.error(`Error fetching tags for ${repo.repo}:`, error);
                return [];
            }
        }

        function renderRepos(repos) {
            const output = document.getElementById('output');
            
            if (repos.length === 0) {
                output.innerHTML = `
                    <div class="empty">
                        <div class="empty-icon">üîç</div>
                        <h3>No Repositories Found</h3>
                        <p>Try adjusting your search criteria</p>
                    </div>
                `;
                return;
            }

            // Sort tags in each repo based on current sort order
            repos.forEach(repo => {
                sortTags(repo.tags);
            });

            const html = `
                <div class="repo-grid">
                    ${repos.map((repo, index) => `
                        <div class="repo-card" data-repo-index="${index}">
                            <div class="repo-name">${escapeHtml(repo.name || repo.repo)}</div>
                            <div class="repo-projects">
                                <div class="repo-project">
                                    <span class="project-label">Project:</span>
                                    <span>${escapeHtml(repo.project || repo.repo)}</span>
                                </div>
                                <div class="repo-project">
                                    <span class="project-label">Repo:</span>
                                    <span>${escapeHtml(repo.repo)}</span>
                                </div>
                            </div>
                            <div class="tags-section">
                                <div class="tags-header">
                                    Tags
                                    <span class="tag-count">${repo.tags.length}</span>
                                </div>
                                <div class="tags-list">
                                    ${repo.tags.length > 0 
                                        ? repo.tags.map(tag => `
                                            <span class="tag">
                                                ${escapeHtml(tag.name)}
                                                <span class="tag-tooltip">
                                                    Commit: ${escapeHtml(tag.shortCommit)}<br>
                                                    Full: ${escapeHtml(tag.commit)}
                                                </span>
                                            </span>
                                        `).join('')
                                        : '<span style="color: #6c757d; font-size: 0.85rem;">No tags</span>'
                                    }
                                </div>
                                <div class="commits-controls" style="margin-top: 15px;">
                                    <label>View commits - Branch:</label>
                                    <select id="branch-select-${index}">
                                        <option value="main">main</option>
                                        <option value="dev">dev</option>
                                        <option value="master">master</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                    <input type="text" id="branch-custom-input-${index}" 
                                           placeholder="custom branch" />
                                    <label>Limit:</label>
                                    <select id="limit-select-${index}">
                                        <option value="5">5</option>
                                        <option value="10" selected>10</option>
                                        <option value="20">20</option>
                                        <option value="50">50</option>
                                    </select>
                                    <button onclick="loadCommitsFromControls(${index})">üìù View Commits</button>
                                </div>
                            </div>
                            <div id="commits-${index}" class="commits-container"></div>
                        </div>
                    `).join('')}
                </div>
            `;

            output.innerHTML = html;
            document.getElementById('stats').classList.remove('hidden');
        }

        async function loadCommitsFromControls(index) {
            const branchSelect = document.getElementById(`branch-select-${index}`);
            const branchCustom = document.getElementById(`branch-custom-input-${index}`);
            const limitSelect = document.getElementById(`limit-select-${index}`);
            
            let branch;
            if (branchSelect.value === 'custom') {
                branch = branchCustom.value.trim();
                if (!branch) {
                    alert('Please enter a custom branch name');
                    return;
                }
            } else {
                branch = branchSelect.value;
            }
            
            const limit = parseInt(limitSelect.value);
            const repo = allRepos[index];
            
            const container = document.getElementById(`commits-${index}`);
            container.innerHTML = `
                <div class="commits-section">
                    <div class="commits-loading">‚è≥ Loading commits...</div>
                </div>
            `;

            try {
                const commits = await fetchRepoCommits(repo, limit, branch);
                
                if (commits.commits.length === 0) {
                    container.innerHTML = `
                        <div class="commits-section">
                            <div class="commits-header">
                                <div class="commits-title">
                                    üìù Commits
                                </div>
                            </div>
                            <div style="text-align: center; padding: 20px; color: #6c757d; font-size: 0.85rem;">
                                No commits found on branch "${escapeHtml(commits.branch)}"
                            </div>
                        </div>
                    `;
                    repoCommitsState[index] = { loaded: true, commits: [] };
                    return;
                }

                repoCommitsState[index] = { loaded: true, commits: commits.commits, branch: commits.branch };
                renderCommits(index, repo, commits.commits, commits.branch);
            } catch (error) {
                container.innerHTML = `
                    <div class="commits-section">
                        <div class="commits-error">
                            ‚ùå Error loading commits: ${escapeHtml(error.message)}
                        </div>
                    </div>
                `;
                delete repoCommitsState[index];
            }
        }

        const repoCommitsState = {}; // Track which repos have commits displayed

        async function fetchRepoCommits(repo, limit = 10, branch = 'dev') {
            const params = new URLSearchParams({
                repo: repo.repo,
                project: repo.project || repo.repo,
                branch: branch,
                limit: limit.toString()
            });

            const response = await fetch(`http://localhost:8000/api/commits?${params}`);
            if (!response.ok) {
                const text = await response.text();
                throw new Error(text || `HTTP ${response.status}`);
            }

            return await response.json();
        }

        function renderCommits(index, repo, commits, branch) {
            const container = document.getElementById(`commits-${index}`);
            
            // Create a map of commit hashes to tags for quick lookup
            const commitTagMap = {};
            repo.tags.forEach(tag => {
                if (!commitTagMap[tag.commit]) {
                    commitTagMap[tag.commit] = [];
                }
                commitTagMap[tag.commit].push(tag.name);
            });
            
            const html = `
                <div class="commits-section">
                    <div class="commits-header">
                        <div class="commits-title">
                            üìù Showing ${commits.length} commits on <strong>${escapeHtml(branch)}</strong>
                        </div>
                    </div>
                    <div class="commits-list">
                        ${commits.map(commit => {
                            const tags = commitTagMap[commit.hash] || [];
                            return `
                            <div class="commit-item">
                                <div class="commit-header">
                                    <span class="commit-hash">${escapeHtml(commit.shortHash)}</span>
                                    <span class="commit-date">${escapeHtml(commit.date)}</span>
                                </div>
                                <div class="commit-subject">${escapeHtml(commit.subject)}</div>
                                ${tags.length > 0 ? `
                                    <div class="commit-tags">
                                        üè∑Ô∏è ${tags.map(tag => `<span class="commit-tag">${escapeHtml(tag)}</span>`).join(' ')}
                                    </div>
                                ` : ''}
                                <div class="commit-author">üë§ ${escapeHtml(commit.author)} &lt;${escapeHtml(commit.email)}&gt;</div>
                                ${commit.body ? `<div class="commit-body">${escapeHtml(commit.body)}</div>` : ''}
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        function sortTags(tags) {
            switch(currentSortOrder) {
                case 'name-asc':
                    tags.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'name-desc':
                    tags.sort((a, b) => b.name.localeCompare(a.name));
                    break;
                case 'commit-asc':
                    tags.sort((a, b) => a.commit.localeCompare(b.commit));
                    break;
                case 'commit-desc':
                    tags.sort((a, b) => b.commit.localeCompare(a.commit));
                    break;
            }
        }

        function filterRepos() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            if (!searchTerm) {
                renderRepos(allRepos);
                return;
            }

            const filtered = allRepos.filter(repo => {
                const repoMatch = repo.repo.toLowerCase().includes(searchTerm);
                const nameMatch = (repo.name || '').toLowerCase().includes(searchTerm);
                const projectMatch = (repo.project || repo.repo).toLowerCase().includes(searchTerm);
                const tagsMatch = repo.tags.some(tag => 
                    tag.name.toLowerCase().includes(searchTerm) ||
                    tag.commit.toLowerCase().includes(searchTerm) ||
                    tag.shortCommit.toLowerCase().includes(searchTerm)
                );
                
                return repoMatch || nameMatch || projectMatch || tagsMatch;
            });

            renderRepos(filtered);
        }

        function updateStats() {
            const totalTags = allRepos.reduce((sum, repo) => sum + repo.tags.length, 0);
            const uniqueProjects = new Set(allRepos.map(r => r.project || r.repo));
            
            document.getElementById('repoCount').textContent = allRepos.length;
            document.getElementById('tagCount').textContent = totalTags;
            document.getElementById('projectCount').textContent = uniqueProjects.size;
        }

        function showLoading() {
            document.getElementById('output').innerHTML = `
                <div class="loading">
                    <h3>Loading repositories...</h3>
                    <p>Fetching tags from Azure DevOps</p>
                </div>
            `;
        }

        function showError(message) {
            document.getElementById('output').innerHTML = `
                <div class="error">
                    <strong>Error:</strong> ${escapeHtml(message)}
                </div>
            `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function openBulkTagModal() {
            if (!config || !allRepos.length) {
                alert('Please load configuration first');
                return;
            }
            document.getElementById('bulkTagModal').style.display = 'block';
            document.getElementById('branchInput').value = '';
            document.getElementById('tagInput').value = '';
            document.getElementById('branchCheckResults').style.display = 'none';
            document.getElementById('progressLog').style.display = 'none';
            document.getElementById('executeTagBtn').disabled = true;
            branchCheckResults = {};
        }

        function closeBulkTagModal() {
            document.getElementById('bulkTagModal').style.display = 'none';
        }

        async function checkBranches() {
            const branchName = document.getElementById('branchInput').value.trim();
            const tagName = document.getElementById('tagInput').value.trim();

            if (!branchName || !tagName) {
                alert('Please enter both branch name and tag name');
                return;
            }

            const statusDiv = document.getElementById('branchStatus');
            const resultsDiv = document.getElementById('branchCheckResults');
            resultsDiv.style.display = 'block';
            statusDiv.innerHTML = '<div class="branch-item checking"><span class="branch-icon">‚è≥</span><span>Checking branches...</span></div>';

            branchCheckResults = {};

            const promises = allRepos.map(async (repo) => {
                try {
                    const params = new URLSearchParams({
                        repo: repo.repo,
                        project: repo.project || repo.repo,
                        baseUrl: repo.baseUrl || config.baseUrl
                    });

                    const response = await fetch(`/api/branches?${params}`);
                    const data = await response.json();
                    
                    const hasBranch = data.branches && data.branches.some(b => b.name === branchName);
                    
                    branchCheckResults[repo.repo] = {
                        name: repo.name || repo.repo,
                        repo: repo.repo,
                        project: repo.project || repo.repo,
                        hasBranch: hasBranch,
                        baseUrl: repo.baseUrl || config.baseUrl,
                        error: data.error
                    };
                } catch (error) {
                    branchCheckResults[repo.repo] = {
                        name: repo.name || repo.repo,
                        repo: repo.repo,
                        project: repo.project || repo.repo,
                        hasBranch: false,
                        baseUrl: repo.baseUrl || config.baseUrl,
                        error: error.message
                    };
                }
            });

            await Promise.all(promises);

            // Display results
            const reposWithBranch = Object.values(branchCheckResults).filter(r => r.hasBranch);
            const reposWithoutBranch = Object.values(branchCheckResults).filter(r => !r.hasBranch);

            let html = '';
            
            if (reposWithBranch.length > 0) {
                html += `<div style="margin-bottom: 15px; font-weight: 600; color: #155724;">‚úì Repositories with branch "${escapeHtml(branchName)}" (${reposWithBranch.length}):</div>`;
                reposWithBranch.forEach(r => {
                    html += `<div class="branch-item has-branch">
                        <span class="branch-icon">‚úì</span>
                        <span class="branch-repo-name">${escapeHtml(r.name)}</span>
                    </div>`;
                });
            }

            if (reposWithoutBranch.length > 0) {
                html += `<div style="margin: 15px 0; font-weight: 600; color: #721c24;">‚ö† Repositories WITHOUT branch "${escapeHtml(branchName)}" (${reposWithoutBranch.length}):</div>`;
                reposWithoutBranch.forEach(r => {
                    const errorMsg = r.error ? ` (${r.error})` : '';
                    html += `<div class="branch-item no-branch">
                        <span class="branch-icon">‚úó</span>
                        <span class="branch-repo-name">${escapeHtml(r.name)}${errorMsg}</span>
                    </div>`;
                });
            }

            statusDiv.innerHTML = html;

            // Enable execute button if at least one repo has the branch
            document.getElementById('executeTagBtn').disabled = reposWithBranch.length === 0;
        }

        async function executeBulkTag() {
            const branchName = document.getElementById('branchInput').value.trim();
            const tagName = document.getElementById('tagInput').value.trim();

            const reposToTag = Object.values(branchCheckResults)
                .filter(r => r.hasBranch)
                .map(r => ({ 
                    repo: r.repo, 
                    project: r.project,
                    baseUrl: r.baseUrl 
                }));

            if (reposToTag.length === 0) {
                alert('No repositories with the specified branch');
                return;
            }

            const confirmMsg = `This will create tag "${tagName}" on branch "${branchName}" for ${reposToTag.length} repositories. Continue?`;
            if (!confirm(confirmMsg)) {
                return;
            }

            // Disable buttons and show progress
            document.getElementById('executeTagBtn').disabled = true;
            document.getElementById('branchInput').disabled = true;
            document.getElementById('tagInput').disabled = true;
            
            const progressLog = document.getElementById('progressLog');
            progressLog.style.display = 'block';
            progressLog.innerHTML = '<div class="progress-log-line info">Starting bulk tagging operation...</div>';

            try {
                const response = await fetch('/api/bulk-tag', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        branch: branchName,
                        tag: tagName,
                        repos: reposToTag
                    })
                });

                const data = await response.json();
                
                // Display results
                let logHtml = '<div class="progress-log-line info">Operation completed!</div>';
                let successCount = 0;
                let failCount = 0;

                data.results.forEach(result => {
                    if (result.success) {
                        successCount++;
                        logHtml += `<div class="progress-log-line success">‚úì ${result.repo}: ${result.message}</div>`;
                    } else {
                        failCount++;
                        logHtml += `<div class="progress-log-line error">‚úó ${result.repo}: ${result.error}</div>`;
                    }
                });

                logHtml += `<div class="progress-log-line info">Summary: ${successCount} successful, ${failCount} failed</div>`;
                progressLog.innerHTML = logHtml;

                // Refresh tags after bulk operation
                if (successCount > 0) {
                    setTimeout(() => {
                        loadAndRefresh();
                    }, 2000);
                }

            } catch (error) {
                progressLog.innerHTML += `<div class="progress-log-line error">Error: ${error.message}</div>`;
            } finally {
                // Re-enable inputs
                document.getElementById('branchInput').disabled = false;
                document.getElementById('tagInput').disabled = false;
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('bulkTagModal');
            if (event.target === modal) {
                closeBulkTagModal();
            }
        }
    </script>
</body>
</html>
